<#@ template debug="false" hostspecific="false" language="C#" #>
<#@ assembly name="System.Core" #>
<#@ assembly name="$(TargetDir)LSDW.Abstractions.dll" #>
<#@ import namespace="System.Linq" #>
<#@ import namespace="System.Reflection" #>
<#@ import namespace="System.Text" #>
<#@ import namespace="System.Collections.Generic" #>
<#@ import namespace="LSDW.Abstractions.Domain.Models" #>
<#@ output extension="Designer.cs" #>
#pragma warning disable CS1591
//------------------------------------------------------------------------------
// <auto-generated>
//     This code was generated by a tool.
//     Changes to this file may cause incorrect behavior and will be lost if
//     the code is regenerated.
// </auto-generated>
//------------------------------------------------------------------------------
namespace LSDW.Infrastructure.Services;

using GTA;
using LSDW.Domain.Factories;

internal sealed partial class SettingsService
{
	private SettingsService()
	{
		_settings = DomainFactory.GetSettings();
		_scriptSettings = ScriptSettings.Load(Path.Combine(AppContext.BaseDirectory, _settings.IniFileName));
		Load();
		Save();

<#
List<PropertyInfo> interfaces = GetProperties(typeof(ISettings));
foreach (PropertyInfo @interface in interfaces.Where(x => x.PropertyType.IsInterface))
{
	List<PropertyInfo> properties = GetProperties(@interface.PropertyType);
	foreach (PropertyInfo property in properties)
	{
		var sectionName = @interface.Name;
		var propertyName = property.Name;
		var dataType = TypeNameOrAlias(property.PropertyType.GetProperties().First().PropertyType);
#>
		_settings.<#= sectionName #>.<#= propertyName #>.Changed += (sender, args) => { _scriptSettings.SetValue("<#= sectionName.ToUpper() #>", "<#= propertyName.ToUpper() #>", args.Value); };
<#
}}
#>
	}

	public void Load()
	{
<#
interfaces = GetProperties(typeof(ISettings));
foreach (PropertyInfo @interface in interfaces.Where(x => x.PropertyType.IsInterface))
{
	List<PropertyInfo> properties = GetProperties(@interface.PropertyType);
	foreach (PropertyInfo property in properties)
	{
		var sectionName = @interface.Name;
		var propertyName = property.Name;
		var dataType = TypeNameOrAlias(property.PropertyType.GetProperties().First().PropertyType);
#>
		<#= dataType #> value<#= propertyName #> = _scriptSettings.GetValue("<#= sectionName.ToUpper() #>", "<#= propertyName.ToUpper() #>", <#= sectionName #>.<#= propertyName #>.Value);
		_scriptSettings.SetValue("<#= sectionName.ToUpper() #>", "<#= propertyName.ToUpper() #>", value<#= propertyName #>);
<#
}}
#>
	}
}
<#+
	private static List<PropertyInfo> GetProperties(Type type)
		=> type.GetProperties().ToList();

	private static string TypeNameOrAlias(Type type)
		=> _typeAlias.TryGetValue(type, out string alias) ? alias : type.Name;

	private static readonly Dictionary<Type, string> _typeAlias = new()
	{
		{ typeof(bool), "bool" },
		{ typeof(byte), "byte" },
		{ typeof(char), "char" },
		{ typeof(decimal), "decimal" },
		{ typeof(double), "double" },
		{ typeof(float), "float" },
		{ typeof(int), "int" },
		{ typeof(long), "long" },
		{ typeof(object), "object" },
		{ typeof(sbyte), "sbyte" },
		{ typeof(short), "short" },
		{ typeof(string), "string" },
		{ typeof(uint), "uint" },
		{ typeof(ulong), "ulong" },
		{ typeof(void), "void" }
	};
#>